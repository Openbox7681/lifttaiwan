package tw.gov.mohw.hisac.web.controller.api;

import java.awt.Image;
import java.io.BufferedOutputStream;
import java.io.IOException;
import java.io.OutputStream;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.text.DecimalFormat;
import java.text.MessageFormat;
import java.util.Date;
import java.util.List;
import java.util.Locale;

import javax.imageio.ImageIO;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.json.JSONObject;
import org.json.JSONArray;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.web.csrf.CsrfToken;
import org.springframework.security.web.csrf.HttpSessionCsrfTokenRepository;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.multipart.MultipartFile;

import tw.gov.mohw.hisac.web.WebCrypto;
import tw.gov.mohw.hisac.web.WebDatetime;
import tw.gov.mohw.hisac.web.WebMessage;
import tw.gov.mohw.hisac.web.controller.BaseController;
import tw.gov.mohw.hisac.web.dao.SystemLogVariable;
import tw.gov.mohw.hisac.web.domain.EventType;
import tw.gov.mohw.hisac.web.domain.MalwareManagement;
import tw.gov.mohw.hisac.web.domain.MalwareManagementAttach;
import tw.gov.mohw.hisac.web.domain.MalwareManagementPic;
import tw.gov.mohw.hisac.web.domain.Member;
import tw.gov.mohw.hisac.web.domain.ProcessLog;
import tw.gov.mohw.hisac.web.domain.SpButtonCount;
import tw.gov.mohw.hisac.web.domain.ViewMalwareManagementMember;
import tw.gov.mohw.hisac.web.domain.ViewMalwareManagementPicMember;
import tw.gov.mohw.hisac.web.domain.ViewMemberRoleMember;
import tw.gov.mohw.hisac.web.domain.ViewMalwareManagementAttachMember;
import tw.gov.mohw.hisac.web.domain.ViewProcessLogMember;
import tw.gov.mohw.hisac.web.service.MalwareManagementService;
import tw.gov.mohw.hisac.web.service.EventTypeService;
import tw.gov.mohw.hisac.web.service.MailService;
import tw.gov.mohw.hisac.web.service.ProcessLogService;
import tw.gov.mohw.hisac.web.service.MalwareManagementAttachService;
import tw.gov.mohw.hisac.web.service.MalwareManagementPicService;


/**
 * 勒索軟體管理控制器
 */
@Controller
@RequestMapping(value = "/sys/api", produces = "application/json; charset=utf-8")
public class s45_MalwareManagementController extends BaseController {

	@Autowired
	private MalwareManagementService malwareManagementService;
	@Autowired
	private MalwareManagementAttachService malwareManagementAttachService;
	@Autowired
	private MalwareManagementPicService malwareManagementPicService;
	
	@Autowired
	private EventTypeService eventTypeService;

	@Autowired
	private ProcessLogService processLogService;

	@Autowired
	private MailService mailService;

	private String targetControllerName = "sys";
	private String targetActionName = "s45";

	/**
	 * 取得MalwareManagement資料API
	 * 
	 * @param locale
	 *            Locale
	 * @param request
	 *            HttpServletRequest
	 * @param model
	 *            Model
	 * @param json
	 *            查詢條件
	 * @return MalwareManagement資料
	 */
	@RequestMapping(value = "/s45/query", method = RequestMethod.POST)
	public String Query(Locale locale, HttpServletRequest request, Model model, @RequestBody String json) {

		JSONObject listjson = new JSONObject();

		/*
		 * MemberRoleVariable.java 與「角色資料維護」 之設定 1-SuperAdmin：IsAdmin
		 * 2-H-ISAC管理者：IsHisac 3-H-ISAC內容維護者：IsHisacContent
		 * 4-H-ISAC內容審核者：IsHisacContentSign 5-H-ISAC警訊建立者：IsHisacInfoBuilder
		 * 6-H-ISAC警訊審核者：IsHisacInfoSign 7-權責單位警訊審核者：IsApplySign
		 * 8-權責單位聯絡人：IsApplyContact 9-權責單位管理者：IsApplyAdmin
		 * 10-會員機構聯絡人：IsMemberContact 11-會員機構管理者：IsMemberAdmin
		 * 12-HISAC通報審核者：IsHisacNotifySign 13-HISAC情資維護者：IsHisacIXContent
		 * 14-HISAC-情資審核者：IsHisacIXContentSign 15-權責單位通報審核者：IsApplySingAdmin
		 */

		json = WebCrypto.getSafe(json);
		JSONObject obj = new JSONObject(json);

		// 取得 RoleId
		if (baseMemberRole.IsAdmin == true) { // 1-SuperAdmin
			obj.put("RoleId", 1);
		} else if (baseMemberRole.IsHisac == true) { // 2-H-ISAC管理者
			obj.put("RoleId", 2);
		} else if (baseMemberRole.IsHisacContent == true) { // 3-H-ISAC內容維護者
			obj.put("RoleId", 3);
		} else if (baseMemberRole.IsHisacContentSign == true) { // 4-H-ISAC內容審核者
			obj.put("RoleId", 4);
		}
		obj.put("MemberId", getBaseMemberId());
		json = obj.toString();

		if (menuService.getReadPermission(getBaseMemberId(), targetControllerName, targetActionName)) {

			JSONArray sn_array = new JSONArray();
			// listjson.put("total",
			// MalwareManagementService.getListSize(json));
			// List<ViewMalwareManagementMember> MalwareManagements =
			// MalwareManagementService.getList(json);

			// 改用 store procedure
			List<ViewMalwareManagementMember> malwareManagements = malwareManagementService.getSpList(json);
			listjson.put("total", malwareManagementService.getSpListSize(json));

			if (malwareManagements != null) {
				for (ViewMalwareManagementMember malwareManagement : malwareManagements) {
					JSONObject sn_json = new JSONObject();
					sn_json.put("Id", malwareManagement.getId());
					sn_json.put("PostId", malwareManagement.getPostId());
					sn_json.put("PostType", malwareManagement.getPostType());
					sn_json.put("PostDateTime", WebDatetime.toString(malwareManagement.getPostDateTime(), "yyyy-MM-dd"));
					sn_json.put("Title", malwareManagement.getTitle());
					sn_json.put("SourceName", malwareManagement.getSourceName());
					sn_json.put("SourceLink", malwareManagement.getSourceLink());
					sn_json.put("ContentType", malwareManagement.getContentType());
					sn_json.put("Content", malwareManagement.getContent());
					sn_json.put("ExternalLink", malwareManagement.getExternalLink());
					sn_json.put("IsBreakLine", malwareManagement.getIsBreakLine());
					sn_json.put("StartDateTime", WebDatetime.toString(malwareManagement.getStartDateTime(), "yyyy-MM-dd"));
					sn_json.put("EndDateTime", WebDatetime.toString(malwareManagement.getEndDateTime(), "yyyy-MM-dd"));
					sn_json.put("IsEnable", malwareManagement.getIsEnable());
					sn_json.put("IsPublic", malwareManagement.getIsPublic());
//					sn_json.put("CreateId", malwareManagement.getCreateId());
					sn_json.put("CreateName", malwareManagement.getCreateName());
					sn_json.put("CreateTime", WebDatetime.toString(malwareManagement.getCreateTime()));
					sn_json.put("ModifyId", malwareManagement.getModifyId());
					sn_json.put("ModifyName", malwareManagement.getModifyName());
					sn_json.put("ModifyTime", WebDatetime.toString(malwareManagement.getModifyTime()));
					sn_json.put("Status", malwareManagement.getStatus());
					sn_json.put("Sort", malwareManagement.getSort());

					// 簽核流程用 - 開始
					String currentStatus = String.valueOf(malwareManagement.getStatus());

					// 依狀態(目前階段)及角色顯示按鍵
					switch (currentStatus) {

						case "1" : // 1-編輯中
							sn_json.put("IsSeeLog", false); // 是否顯示簽核資訊

							if (baseMemberRole.IsAdmin || baseMemberRole.IsHisac || baseMemberRole.IsHisacContent) {
								// 3-H-ISAC內容維護者：編輯、刪除
								sn_json.put("IsButtonEdit", true); // 是否顯示編輯按鍵
								sn_json.put("IsButtonDelete", true); // 是否顯示刪除按鍵
							} else {
								// 其他角色：無權限
								sn_json.put("IsButtonEdit", false); // 是否顯示編輯按鍵
								sn_json.put("IsButtonDelete", false); // 是否顯示刪除按鍵
							}

							sn_json.put("IsButtonUndo", false); // 是否顯示撤銷按鍵
							sn_json.put("IsButtonReview", false); // 是否顯示審核按鍵
							break;

						case "2" : // 2-撤銷中
							sn_json.put("IsSeeLog", true); // 是否顯示簽核資訊
							sn_json.put("IsButtonEdit", false); // 是否顯示編輯按鍵
							sn_json.put("IsButtonDelete", false); // 是否顯示刪除按鍵

							if (baseMemberRole.IsAdmin || baseMemberRole.IsHisac || baseMemberRole.IsHisacContent) {
								sn_json.put("IsButtonUndo", true); // 是否顯示撤銷按鍵
							} else {
								sn_json.put("IsButtonUndo", false); // 是否顯示撤銷按鍵
							}

							sn_json.put("IsButtonReview", false); // 是否顯示審核按鍵
							break;

						case "3" : // 3-審核中
							sn_json.put("IsSeeLog", true); // 是否顯示簽核資訊
							sn_json.put("IsButtonEdit", false); // 是否顯示編輯按鍵
							sn_json.put("IsButtonDelete", false); // 是否顯示刪除按鍵
							sn_json.put("IsButtonUndo", false); // 是否顯示撤銷按鍵

							if (baseMemberRole.IsAdmin || baseMemberRole.IsHisac || baseMemberRole.IsHisacContentSign) {
								sn_json.put("IsButtonReview", true); // 是否顯示審核按鍵
							} else {
								sn_json.put("IsButtonReview", false); // 是否顯示審核按鍵
							}
							break;

						case "4" : // 4-已公告
							sn_json.put("IsSeeLog", true); // 是否顯示簽核資訊
							sn_json.put("IsButtonEdit", false); // 是否顯示編輯按鍵
							sn_json.put("IsButtonDelete", false); // 是否顯示刪除按鍵
							sn_json.put("IsButtonUndo", false); // 是否顯示撤銷按鍵
							sn_json.put("IsButtonReview", false); // 是否顯示審核按鍵
							break;

						case "5" : // 5-已銷案
							sn_json.put("IsSeeLog", true); // 是否顯示簽核資訊
							sn_json.put("IsButtonEdit", false); // 是否顯示編輯按鍵
							sn_json.put("IsButtonDelete", false); // 是否顯示刪除按鍵
							sn_json.put("IsButtonUndo", false); // 是否顯示撤銷按鍵
							sn_json.put("IsButtonReview", false); // 是否顯示審核按鍵
							break;

						case "6" : // 6-編輯中(退回)
							sn_json.put("IsSeeLog", false); // 是否顯示簽核資訊

							if (baseMemberRole.IsAdmin || baseMemberRole.IsHisac || baseMemberRole.IsHisacContent) {
								sn_json.put("IsButtonEdit", true); // 是否顯示編輯按鍵
							} else {
								sn_json.put("IsButtonEdit", false); // 是否顯示編輯按鍵
							}

							sn_json.put("IsButtonDelete", false); // 是否顯示刪除按鍵
							sn_json.put("IsButtonUndo", false); // 是否顯示撤銷按鍵
							sn_json.put("IsButtonReview", false); // 是否顯示審核按鍵
							break;

						default :
							sn_json.put("IsSeeLog", false); // 是否顯示簽核資訊
							sn_json.put("IsButtonEdit", false); // 是否顯示編輯按鍵
							sn_json.put("IsButtonDelete", false); // 是否顯示刪除按鍵
							sn_json.put("IsButtonUndo", false); // 是否顯示撤銷按鍵
							sn_json.put("IsButtonReview", false); // 是否顯示審核按鍵
							break;

					}
					// 簽核流程用 - 結束

					sn_array.put(sn_json);
				}
				listjson.put("datatable", sn_array);
				systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Read, SystemLogVariable.Status.Success, getBaseIpAddress(), getBaseMemberAccount());
			}
		} else {
			systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Read, SystemLogVariable.Status.Deny, getBaseIpAddress(), getBaseMemberAccount());
		}
		model.addAttribute("json", listjson.toString());
		return "msg";
	}

	/**
	 * 取得MalwareManagement資料API
	 * 
	 * @param locale
	 *            Locale
	 * @param request
	 *            HttpServletRequest
	 * @param model
	 *            Model
	 * @param json
	 *            MalwareManagement資料
	 * @return MalwareManagement資料
	 */
	@RequestMapping(value = "/s45/query/id", method = RequestMethod.POST)
	public String QueryById(Locale locale, HttpServletRequest request, Model model, @RequestBody String json) {
		JSONArray sn_array = new JSONArray();
		if (menuService.getReadPermission(getBaseMemberId(), targetControllerName, targetActionName)) {
			json = WebCrypto.getSafe(json);
			JSONObject obj = new JSONObject(json);
			long id = obj.isNull("Id") == true ? 0 : obj.getLong("Id");

			// 流程紀錄用
			String tableName = obj.isNull("TableName") == true ? null : obj.getString("TableName");

			// 取得指定 id 之活動訊息資料
			MalwareManagement malwareManagement = malwareManagementService.get(id);

			// 流程紀錄用 - 開始
			JSONArray messageLog_array = new JSONArray();
			Date today = new Date();
			List<ViewProcessLogMember> messageLogs = processLogService.getByPostId(String.valueOf(id), tableName);
			if (messageLogs != null) {
				for (ViewProcessLogMember messageLog : messageLogs) {
					JSONObject messageLog_json = new JSONObject();
					messageLog_json.put("PreStatus", messageLog.getPreStatus());
					messageLog_json.put("Status", messageLog.getStatus());
					messageLog_json.put("CreateTime", WebDatetime.toString(messageLog.getCreateTime()));
					messageLog_json.put("Opinion", messageLog.getOpinion());
					messageLog_json.put("CreateName", messageLog.getCreateName());
					messageLog_json.put("PreName", messageLog.getPreName());
					messageLog_json.put("Days", (today.getTime() - messageLog.getCreateTime().getTime()) / (1000 * 60 * 60 * 24));
					messageLog_array.put(messageLog_json);
				}
			}
			// 流程紀錄用 - 結束

			JSONObject sn_json = new JSONObject();
			sn_json.put("Id", malwareManagement.getId());
			sn_json.put("PostId", malwareManagement.getPostId());
			sn_json.put("PostType", malwareManagement.getPostType());
			sn_json.put("PostDateTime", WebDatetime.toString(malwareManagement.getPostDateTime(), "yyyy-MM-dd"));
			sn_json.put("Title", malwareManagement.getTitle());
			sn_json.put("SourceName", malwareManagement.getSourceName());
			sn_json.put("SourceLink", malwareManagement.getSourceLink());
			sn_json.put("ContentType", malwareManagement.getContentType());
			sn_json.put("Content", malwareManagement.getContent());
			sn_json.put("ExternalLink", malwareManagement.getExternalLink());
			sn_json.put("IsBreakLine", malwareManagement.getIsBreakLine());
			sn_json.put("StartDateTime", WebDatetime.toString(malwareManagement.getStartDateTime(), "yyyy-MM-dd"));
			sn_json.put("EndDateTime", WebDatetime.toString(malwareManagement.getEndDateTime(), "yyyy-MM-dd"));
			sn_json.put("IsEnable", malwareManagement.getIsEnable());
			sn_json.put("IsPublic", malwareManagement.getIsPublic());
			sn_json.put("CreateId", malwareManagement.getCreateId());
			sn_json.put("CreateTime", WebDatetime.toString(malwareManagement.getCreateTime()));
			sn_json.put("ModifyId", malwareManagement.getModifyId());
			sn_json.put("ModifyTime", WebDatetime.toString(malwareManagement.getModifyTime()));
			sn_json.put("Status", malwareManagement.getStatus());
			sn_json.put("Sort", malwareManagement.getSort());
			sn_json.put("EventCode", malwareManagement.getEventTypeCode());
			if (malwareManagement.getEventTypeCode() != null) {
				EventType eventType = eventTypeService.findByCode(malwareManagement.getEventTypeCode());
				sn_json.put("EventTypeCodeName", eventType.getName());
			}
			
			sn_json.put("ReporterName", malwareManagement.getReporterName());
			sn_json.put("ResponderPartyName", malwareManagement.getResponderPartyName());
			sn_json.put("ResponderContactNumbers", malwareManagement.getResponderContactNumbers());
			sn_json.put("ResponderElectronicAddressIdentifiers", malwareManagement.getResponderElectronicAddressIdentifiers());
			sn_json.put("ImpactQualification", malwareManagement.getImpactQualification());
			sn_json.put("CoaDescription", malwareManagement.getCoaDescription());
			sn_json.put("Confidence", malwareManagement.getConfidence());
			sn_json.put("Reference", malwareManagement.getReference());
			sn_json.put("AffectedSoftwareDescription", malwareManagement.getAffectedSoftwareDescription());
			
			
			
			

			// 流程紀錄用，將取得之流程紀錄放入 sn_json 中
			sn_json.put("MessageLog", messageLog_array);

			sn_array.put(sn_json);
			systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Read, SystemLogVariable.Status.Success, getBaseIpAddress(), getBaseMemberAccount());
		} else {
			systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Read, SystemLogVariable.Status.Deny, getBaseIpAddress(), getBaseMemberAccount());
		}
		model.addAttribute("json", sn_array.toString());
		return "msg";
	}

	/**
	 * 新增MalwareManagement資料API
	 * 
	 * @param locale
	 *            Locale
	 * @param request
	 *            HttpServletRequest
	 * @param json
	 *            MalwareManagement
	 * @return 是否新增成功
	 */
	@RequestMapping(value = "/s45/create", method = RequestMethod.POST)
	public @ResponseBody String Create(Locale locale, HttpServletRequest request, @RequestBody String json) {
		JSONObject responseJson = new JSONObject();
		CsrfToken token = new HttpSessionCsrfTokenRepository().loadToken(request);
		if (token == null || token.getToken().equals(""))
			return responseJson.toString();
		
		if (menuService.getCreatePermission(getBaseMemberId(), targetControllerName, targetActionName)) {
			json = WebCrypto.getSafe(json);

			MalwareManagement malwaremanagement = malwareManagementService.insert(getBaseMemberId(), json, false);

			// 流程紀錄用 - 開始
			JSONObject obj = new JSONObject(json);
			Boolean isWriteProcessLog = obj.isNull("IsWriteProcessLog") == true ? false : obj.getBoolean("IsWriteProcessLog");

			if (isWriteProcessLog) {
				// 寄信
				// 收件者：memberService.get((memberRoleService.findByRoleId(4)).getMemberId()).getEmail()
				// 主旨：H-ISAC活動訊息("not.getPostId()")審核通知
				// 內容：memberService.get((memberRoleService.findByRoleId(4)).getMemberId()).getName()，您好！勒索專區文章("not.getPostId()")，正等待您的審查，請您儘快撥冗進行處理，謝謝！
				List<ViewMemberRoleMember> memberRoles = memberRoleService.findByRoleId(4); // 4
																							// H-ISAC內容審核者
				if (memberRoles != null) {
					for (ViewMemberRoleMember memberRole : memberRoles) {
						Member member = memberService.get(memberRole.getMemberId());
						if (member != null && member.getIsEnable()) {
							String mailSubject = MessageFormat.format(resourceMessageService.getMessageValue("mailMalware1To3Subject"), malwaremanagement.getPostId());
							String mailBody = MessageFormat.format(resourceMessageService.getMessageValue("mailMalware1To3Body"), member.getName(), malwaremanagement.getPostId());
							mailService.Send(this.getClass().getSimpleName() + " - " + Thread.currentThread().getStackTrace()[1].getMethodName(), member.getEmail(), member.getSpareEmail(), null, mailSubject, mailBody, null);
						}
					}
				}

				processLogService.insert(getBaseMemberId(), json, String.valueOf(malwaremanagement.getId()));
			}
			// 流程紀錄用 - 結束

			if (malwaremanagement != null) {

				// 流程紀錄用 - 開始
				responseJson.put("Id", malwaremanagement.getId());
				responseJson.put("PostId", malwaremanagement.getPostId());
				// 流程紀錄用 - 結束

				responseJson.put("msg", WebMessage.getMessage("globalInsertDataSuccess", null, locale));
				responseJson.put("success", true);
				systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Create, SystemLogVariable.Status.Success, getBaseIpAddress(), getBaseMemberAccount());
			} else {
				responseJson.put("msg", WebMessage.getMessage("globalInsertDataFail", null, locale));
				responseJson.put("success", false);
				systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Create, SystemLogVariable.Status.Fail, getBaseIpAddress(), getBaseMemberAccount());
			}
		} else {
			responseJson.put("msg", WebMessage.getMessage("globalPermissionDeny", null, locale));
			responseJson.put("success", false);
			systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Create, SystemLogVariable.Status.Deny, getBaseIpAddress(), getBaseMemberAccount());
		}
		return WebCrypto.getSafe(responseJson.toString());
	}

	/**
	 * 更新malwareManagement資料API
	 * 
	 * @param locale
	 *            Locale
	 * @param request
	 *            HttpServletRequest
	 * @param json
	 *            malwareManagement
	 * @return 是否更新成功
	 */
	@RequestMapping(value = "/s45/update", method = RequestMethod.POST)
	public @ResponseBody String Update(Locale locale, HttpServletRequest request, @RequestBody String json) {
		JSONObject responseJson = new JSONObject();
		CsrfToken token = new HttpSessionCsrfTokenRepository().loadToken(request);
		if (token == null || token.getToken().equals(""))
			return responseJson.toString();
		
		if (menuService.getUpdatePermission(getBaseMemberId(), targetControllerName, targetActionName)) {
			json = WebCrypto.getSafe(json);
			JSONObject obj = new JSONObject(json);
			long id = obj.getLong("Id");
			if (!malwareManagementService.isExist(id)) {
				responseJson.put("msg", WebMessage.getMessage("globalDataNotExist", null, locale));
				responseJson.put("success", false);
				systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Update, SystemLogVariable.Status.Fail, getBaseIpAddress(), getBaseMemberAccount());
			} else {
				MalwareManagement malwareManagement = malwareManagementService.update(getBaseMemberId(), json, false);

				// 流程紀錄用 - 開始
				Boolean isWriteProcessLog = obj.isNull("IsWriteProcessLog") == true ? false : obj.getBoolean("IsWriteProcessLog");

				if (isWriteProcessLog) {
					processLogService.insert(getBaseMemberId(), json, String.valueOf(malwareManagement.getId()));

					// 寄信
					// 收件者：memberService.get((memberRoleService.findByRoleId(4)).getMemberId()).getEmail()
					// 主旨：H-ISAC勒索專區文章("not.getPostId()")審核通知
					// 內容：memberService.get((memberRoleService.findByRoleId(4)).getMemberId()).getName()，您好！勒索專區文章("not.getPostId()")，正等待您的審查，請您儘快撥冗進行處理，謝謝！
					List<ViewMemberRoleMember> memberRoles = memberRoleService.findByRoleId(4); // 4
																								// H-ISAC內容審核者
					if (memberRoles != null) {
						for (ViewMemberRoleMember memberRole : memberRoles) {
							Member member = memberService.get(memberRole.getMemberId());
							if (member != null && member.getIsEnable()) {
								String mailSubject = MessageFormat.format(resourceMessageService.getMessageValue("mailMalware1To3Subject"), malwareManagement.getPostId());
								String mailBody = MessageFormat.format(resourceMessageService.getMessageValue("mailMalware1To3Body"), member.getName(), malwareManagement.getPostId());
								mailService.Send(this.getClass().getSimpleName() + " - " + Thread.currentThread().getStackTrace()[1].getMethodName(), member.getEmail(), member.getSpareEmail(), null, mailSubject, mailBody, null);
							}
						}
					}
				}
				// 流程紀錄用 - 結束

				if (malwareManagement != null) {

					// 流程紀錄用 - 開始
					responseJson.put("Id", malwareManagement.getId());
					responseJson.put("PostId", malwareManagement.getPostId());
					// 流程紀錄用 - 結束

					responseJson.put("msg", WebMessage.getMessage("globalUpdateDataSuccess", null, locale));
					responseJson.put("success", true);
					systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Update, SystemLogVariable.Status.Success, getBaseIpAddress(), getBaseMemberAccount());
				} else {
					responseJson.put("msg", WebMessage.getMessage("globalUpdateDataFail", null, locale));
					responseJson.put("success", false);
					systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Update, SystemLogVariable.Status.Fail, getBaseIpAddress(), getBaseMemberAccount());
				}
			}
		} else {
			responseJson.put("msg", WebMessage.getMessage("globalPermissionDeny", null, locale));
			responseJson.put("success", false);
			systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Update, SystemLogVariable.Status.Deny, getBaseIpAddress(), getBaseMemberAccount());
		}
		return WebCrypto.getSafe(responseJson.toString());
	}
	
	/**
	 * 更新malwareManagement資料API
	 * 
	 * @param locale
	 *            Locale
	 * @param request
	 *            HttpServletRequest
	 * @param json
	 *            malwareManagement
	 * @return 是否更新成功
	 */
	@RequestMapping(value = "/s45/modify", method = RequestMethod.POST)
	public @ResponseBody String Modify(Locale locale, HttpServletRequest request, @RequestBody String json) {
		JSONObject responseJson = new JSONObject();
		CsrfToken token = new HttpSessionCsrfTokenRepository().loadToken(request);
		if (token == null || token.getToken().equals(""))
			return responseJson.toString();
		
		if (menuService.getUpdatePermission(getBaseMemberId(), targetControllerName, targetActionName)) {
			json = WebCrypto.getSafe(json);
			JSONObject obj = new JSONObject(json);
			long id = obj.getLong("Id");

			if (!malwareManagementService.isExist(id)) {
				responseJson.put("msg", WebMessage.getMessage("globalDataNotExist", null, locale));
				responseJson.put("success", false);
				systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Update, SystemLogVariable.Status.Fail, getBaseIpAddress(), getBaseMemberAccount());
			} else {
				MalwareManagement malwareManagement = malwareManagementService.modify(getBaseMemberId(), json, false);
				if (malwareManagement != null) {
					responseJson.put("Id", malwareManagement.getId());
					responseJson.put("PostId", malwareManagement.getPostId());
					responseJson.put("msg", WebMessage.getMessage("globalUpdateDataSuccess", null, locale));
					responseJson.put("success", true);
					systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Update, SystemLogVariable.Status.Success, getBaseIpAddress(), getBaseMemberAccount());
				} else {
					responseJson.put("msg", WebMessage.getMessage("globalUpdateDataFail", null, locale));
					responseJson.put("success", false);
					systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Update, SystemLogVariable.Status.Fail, getBaseIpAddress(), getBaseMemberAccount());
				}
			}
		} else {
			responseJson.put("msg", WebMessage.getMessage("globalPermissionDeny", null, locale));
			responseJson.put("success", false);
			systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Update, SystemLogVariable.Status.Deny, getBaseIpAddress(), getBaseMemberAccount());
		}
		return WebCrypto.getSafe(responseJson.toString());
	}

	/**
	 * 刪除malwareManagement資料API,連帶刪除附檔與圖片
	 * 
	 * @param locale
	 *            Locale
	 * @param request
	 *            HttpServletRequest
	 * @param json
	 *            編號
	 * @return 是否刪除成功
	 */
	@RequestMapping(value = "/s45/delete", method = RequestMethod.POST)
	public @ResponseBody String Delete(Locale locale, HttpServletRequest request, @RequestBody String json) {
		JSONObject responseJson = new JSONObject();
		CsrfToken token = new HttpSessionCsrfTokenRepository().loadToken(request);
		if (token == null || token.getToken().equals(""))
			return responseJson.toString();
		
		if (menuService.getDeletePermission(getBaseMemberId(), targetControllerName, targetActionName)) {
			json = WebCrypto.getSafe(json);
			JSONObject obj = new JSONObject(json);
			long id = obj.isNull("Id") == true ? 0 : obj.getLong("Id");
			if (!malwareManagementService.isExist(id)) {
				responseJson.put("msg", WebMessage.getMessage("globalDataNotExist", null, locale));
				responseJson.put("success", false);
				systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Delete, SystemLogVariable.Status.Fail, getBaseIpAddress(), getBaseMemberAccount());
			} else {
				try {
					List<ViewMalwareManagementPicMember> malwareManagementPics = malwareManagementPicService.getAllByMalwareManagementId(id);
					if (malwareManagementPics != null) {
						for (ViewMalwareManagementPicMember malwareManagementPic : malwareManagementPics) {
							malwareManagementPicService.delete(malwareManagementPic.getId());
						}
					}
				} catch (Exception e) {
					//e.printStackTrace();
				}
				try {
					List<ViewMalwareManagementAttachMember> malwareManagementAttachs = malwareManagementAttachService.getAllByMalwareManagementId(id);
					if (malwareManagementAttachs != null) {
						for (ViewMalwareManagementAttachMember malwareManagementAttach : malwareManagementAttachs) {
							malwareManagementAttachService.delete(malwareManagementAttach.getId());
						}
					}
				} catch (Exception e) {
					//e.printStackTrace();
				}
				if (malwareManagementService.delete(id)) {
					responseJson.put("msg", WebMessage.getMessage("globalDeleteDataSuccess", null, locale));
					responseJson.put("success", true);
					systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Delete, SystemLogVariable.Status.Success, getBaseIpAddress(), getBaseMemberAccount());
				} else {
					responseJson.put("msg", WebMessage.getMessage("globalDeleteDataFail", null, locale));
					responseJson.put("success", false);
					systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Delete, SystemLogVariable.Status.Fail, getBaseIpAddress(), getBaseMemberAccount());
				}
			}
		} else {
			responseJson.put("msg", WebMessage.getMessage("globalPermissionDeny", null, locale));
			responseJson.put("success", false);
			systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Delete, SystemLogVariable.Status.Deny, getBaseIpAddress(), getBaseMemberAccount());
		}
		return WebCrypto.getSafe(responseJson.toString());
	}
	
	/**
	 * 停用malwareManagement資料API
	 * 
	 * @param locale
	 *            Locale
	 * @param request
	 *            HttpServletRequest
	 * @param json
	 *            malwareManagement
	 * @return 是否更新成功
	 */
	@RequestMapping(value = "/s45/disable", method = RequestMethod.POST)
	public @ResponseBody String Disable(Locale locale, HttpServletRequest request, @RequestBody String json) {
		JSONObject responseJson = new JSONObject();
		CsrfToken token = new HttpSessionCsrfTokenRepository().loadToken(request);
		if (token == null || token.getToken().equals(""))
			return responseJson.toString();
		
		if (menuService.getUpdatePermission(getBaseMemberId(), targetControllerName, targetActionName)) {
			json = WebCrypto.getSafe(json);
			JSONObject obj = new JSONObject(json);
			long id = obj.getLong("Id");
			if (!malwareManagementService.isExist(id)) {
				responseJson.put("msg", WebMessage.getMessage("globalDataNotExist", null, locale));
				responseJson.put("success", false);
				systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Update, SystemLogVariable.Status.Fail, getBaseIpAddress(), getBaseMemberAccount());
			} else {
				malwareManagementService.disable(getBaseMemberId(), id);
			}
		} else {
			responseJson.put("msg", WebMessage.getMessage("globalPermissionDeny", null, locale));
			responseJson.put("success", false);
			systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Update, SystemLogVariable.Status.Deny, getBaseIpAddress(), getBaseMemberAccount());
		}
		return WebCrypto.getSafe(responseJson.toString());
	}

	/**
	 * 取得圖片資料API
	 * 
	 * @param locale
	 *            Locale
	 * @param request
	 *            HttpServletRequest
	 * @param model
	 *            Model
	 * @param json
	 *            查詢條件
	 * @return 圖片資料
	 */
	@RequestMapping(value = "/s45/pic/query", method = RequestMethod.POST)
	public String QueryPic(Locale locale, HttpServletRequest request, Model model, @RequestBody String json) {
		JSONObject listjson = new JSONObject();
		if (menuService.getReadPermission(getBaseMemberId(), targetControllerName, targetActionName)) {
			JSONArray sn_array = new JSONArray();
			
			json = WebCrypto.getSafe(json);
			JSONObject obj = new JSONObject(json);
			long malwareManagementId = obj.isNull("MalwareManagementId") == true ? 0 : obj.getLong("MalwareManagementId");
			List<ViewMalwareManagementPicMember> malwareManagementPics = malwareManagementPicService.getAllByMalwareManagementId(malwareManagementId);
			if (malwareManagementPics != null) {
				for (ViewMalwareManagementPicMember malwareManagementPic : malwareManagementPics) {
					long size = malwareManagementPic.getFileSize();
					if (size <= 0)
						return "0";
					final String[] units = new String[]{"B", "KB", "MB", "GB", "TB"};
					int digitGroups = (int) (Math.log10(size) / Math.log10(1024));
					String fileSize = new DecimalFormat("#,##0.#").format(size / Math.pow(1024, digitGroups)) + " " + units[digitGroups];
					
					//TODO p13 malware 檔案下載 controller 
					String imageLink = "<img src=\"./api/p02/pic/download/" + malwareManagementId + "/" + malwareManagementPic.getId() + "\" title=\"" + malwareManagementPic.getFileDesc() + "\" width=\"" + malwareManagementPic.getImageWidth() + "\">";
					JSONObject sn_json = new JSONObject();
					sn_json.put("Id", malwareManagementPic.getId());
					sn_json.put("FileName", malwareManagementPic.getFileName());
					sn_json.put("FileType", malwareManagementPic.getFileType());
					sn_json.put("FileSize", fileSize);
					sn_json.put("ImageWidth", malwareManagementPic.getImageWidth());
					sn_json.put("ImageHeight", malwareManagementPic.getImageHeight());
					sn_json.put("ImageLink", imageLink);
					sn_json.put("FileDesc", malwareManagementPic.getFileDesc());
					sn_json.put("CreateId", malwareManagementPic.getCreateId());
					sn_json.put("CreateName", malwareManagementPic.getCreateName());
					sn_json.put("CreateTime", WebDatetime.toString(malwareManagementPic.getCreateTime()));
					sn_json.put("ModifyId", malwareManagementPic.getModifyId());
					sn_json.put("ModifyName", malwareManagementPic.getModifyName());
					sn_json.put("ModifyTime", WebDatetime.toString(malwareManagementPic.getModifyTime()));
					sn_array.put(sn_json);
				}
				listjson.put("datatable", sn_array);
				systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Read, SystemLogVariable.Status.Success, getBaseIpAddress(), getBaseMemberAccount());
			}
		} else {
			systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Read, SystemLogVariable.Status.Deny, getBaseIpAddress(), getBaseMemberAccount());
		}
		model.addAttribute("json", listjson.toString());
		return "msg";
	}

	/**
	 * 上傳圖檔API
	 * 
	 * @param file
	 *            MultipartFile
	 * @param id
	 *            MalwareManagementId
	 * @param fileDesc
	 *            檔案描述
	 * @param model
	 *            Model
	 * @param locale
	 *            Locale
	 * @param request
	 *            HttpServletRequest
	 * @return 是否成功
	 */
	@RequestMapping(value = "/s45/pic/upload", method = RequestMethod.POST)
	public String UploadPic(@RequestParam("file") MultipartFile file, @RequestParam("id") Long id, @RequestParam("FileDesc") String fileDesc, Model model, Locale locale, HttpServletRequest request) {
		JSONObject responseJson = new JSONObject();
		CsrfToken token = new HttpSessionCsrfTokenRepository().loadToken(request);
		if (token == null || token.getToken().equals(""))
			return responseJson.toString();
		
		if (menuService.getCreatePermission(getBaseMemberId(), targetControllerName, targetActionName)) {
			JSONObject sn_json = new JSONObject();
			sn_json.put("MalwareManagementId", id);
			sn_json.put("FileDesc", fileDesc);
			String json = sn_json.toString();
			if (!file.isEmpty()) {
				try {
					byte[] bytes = file.getBytes();
					sn_json.put("FileName", file.getOriginalFilename());
					sn_json.put("FileType", file.getContentType());
					sn_json.put("FileSize", file.getSize());
					Image image = ImageIO.read(file.getInputStream());
					int imageWidth = image.getWidth(null);
					int imageHeight = image.getHeight(null);
					sn_json.put("FileHash", WebCrypto.getHash(WebCrypto.HashType.SHA256, bytes.toString()));
					sn_json.put("ImageWidth", imageWidth);
					sn_json.put("ImageHeight", imageHeight);
					json = sn_json.toString();
					MalwareManagement malwareManagement = malwareManagementService.get(id);
					if (malwareManagement != null) {
						MalwareManagementPic entity = malwareManagementPicService.insert(getBaseMemberId(), json, bytes);
						if (entity != null) {
							responseJson.put("msg", WebMessage.getMessage("globalUploadFileSuccess", null, locale));
							responseJson.put("success", true);
							systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Create, SystemLogVariable.Status.Success, getBaseIpAddress(), getBaseMemberAccount());
						} else {
							responseJson.put("msg", WebMessage.getMessage("globalUploadFileFail", null, locale));
							responseJson.put("success", false);
							systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Create, SystemLogVariable.Status.Fail, getBaseIpAddress(), getBaseMemberAccount());
						}
					} else {
						responseJson.put("msg", WebMessage.getMessage("globalUploadFileFail", null, locale));
						responseJson.put("success", false);
						systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Create, SystemLogVariable.Status.Fail, getBaseIpAddress(), getBaseMemberAccount());
					}
				} catch (Exception e) {
					e.printStackTrace();
					responseJson.put("msg", WebMessage.getMessage("globalUploadFileFail", null, locale));
					responseJson.put("success", false);
					systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Create, SystemLogVariable.Status.Fail, getBaseIpAddress(), getBaseMemberAccount());
				}
			} else {
				responseJson.put("msg", WebMessage.getMessage("globalUploadFileFail", null, locale));
				responseJson.put("success", false);
				systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Create, SystemLogVariable.Status.Fail, getBaseIpAddress(), getBaseMemberAccount());
			}
		} else {
			systemLogService.insert(baseControllerName, baseActionName, "MalwareManagementId=" + id.toString(), SystemLogVariable.Action.Create, SystemLogVariable.Status.Deny, getBaseIpAddress(), getBaseMemberAccount());
		}
		model.addAttribute("json", responseJson.toString());
		return "msg";
	}

	/**
	 * 刪除圖檔API
	 * 
	 * @param locale
	 *            Locale
	 * @param request
	 *            HttpServletRequest
	 * @param json
	 *            編號
	 * @return 是否刪除成功
	 */
	@RequestMapping(value = "/s45/pic/delete", method = RequestMethod.POST)
	public @ResponseBody String DeletePic(Locale locale, HttpServletRequest request, @RequestBody String json) {
		JSONObject responseJson = new JSONObject();
		CsrfToken token = new HttpSessionCsrfTokenRepository().loadToken(request);
		if (token == null || token.getToken().equals(""))
			return responseJson.toString();
		
		if (menuService.getDeletePermission(getBaseMemberId(), targetControllerName, targetActionName)) {
			json = WebCrypto.getSafe(json);
			JSONObject obj = new JSONObject(json);
			long id = obj.isNull("Id") == true ? 0 : obj.getLong("Id");
			if (!malwareManagementPicService.isExist(id)) {
				responseJson.put("msg", WebMessage.getMessage("globalDataNotExist", null, locale));
				responseJson.put("success", false);
				systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Delete, SystemLogVariable.Status.Fail, getBaseIpAddress(), getBaseMemberAccount());
			} else {
				if (malwareManagementPicService.delete(id)) {
					responseJson.put("msg", WebMessage.getMessage("globalDeleteDataSuccess", null, locale));
					responseJson.put("success", true);
					systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Delete, SystemLogVariable.Status.Success, getBaseIpAddress(), getBaseMemberAccount());
				} else {
					responseJson.put("msg", WebMessage.getMessage("globalDeleteDataFail", null, locale));
					responseJson.put("success", false);
					systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Delete, SystemLogVariable.Status.Fail, getBaseIpAddress(), getBaseMemberAccount());
				}
			}
		} else {
			responseJson.put("msg", WebMessage.getMessage("globalPermissionDeny", null, locale));
			responseJson.put("success", false);
			systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Delete, SystemLogVariable.Status.Deny, getBaseIpAddress(), getBaseMemberAccount());
		}
		return WebCrypto.getSafe(responseJson.toString());
	}

	/**
	 * 圖片輸出
	 * 
	 * @param locale
	 *            Locale
	 * @param request
	 *            HttpServletRequest
	 * @param response
	 *            HttpServletResponse
	 * @param MalwareManagementId
	 *            文章Id
	 * @param id
	 *            圖檔Id
	 */
	@RequestMapping(value = "/s45/pic/download/{malwareManagementId}/{id}", method = RequestMethod.GET)
	public void ShowPic(Locale locale, HttpServletRequest request, HttpServletResponse response, @PathVariable Long malwareManagementId, @PathVariable Long id) {
		JSONObject sn_json = new JSONObject();
		sn_json.put("MalwareManagementId", malwareManagementId);
		sn_json.put("Id", id);
		String json = sn_json.toString();
		if (menuService.getReadPermission(getBaseMemberId(), targetControllerName, targetActionName)) {
			if (!malwareManagementService.isExist(malwareManagementId)) {
				systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Read, SystemLogVariable.Status.Fail, getBaseIpAddress(), getBaseMemberAccount());
				try {
					response.sendError(HttpServletResponse.SC_NOT_FOUND);
				} catch (IOException ex) {
					//ex.printStackTrace();
				}
			} else if (!malwareManagementPicService.isExist(id)) {
				systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Read, SystemLogVariable.Status.Fail, getBaseIpAddress(), getBaseMemberAccount());
				try {
					response.sendError(HttpServletResponse.SC_NOT_FOUND);
				} catch (IOException ex) {
					//ex.printStackTrace();
				}
			} else {
				response.reset();
				MalwareManagementPic malwareManagementPic = malwareManagementPicService.getById(id);
				try {
					byte[] buffer =  malwareManagementPic.getFileContent();
					response.addHeader("Content-Disposition", "attachment;filename=" + URLEncoder.encode(malwareManagementPic.getFileName(), StandardCharsets.UTF_8.toString()));
					response.addHeader("Content-Length", "" + buffer.length);
					OutputStream toClient = new BufferedOutputStream(response.getOutputStream());
					response.setContentType(malwareManagementPic.getFileType());
					toClient.write(buffer);
					toClient.flush();
					toClient.close();
					systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Read, SystemLogVariable.Status.Success, getBaseIpAddress(), getBaseMemberAccount());
				} catch (IOException ex) {
					//ex.printStackTrace();
					systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Read, SystemLogVariable.Status.Fail, getBaseIpAddress(), getBaseMemberAccount());
				}
			}
		} else {
			systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Read, SystemLogVariable.Status.Deny, getBaseIpAddress(), getBaseMemberAccount());
		}
	}

	/**
	 * 取得附件資料API
	 * 
	 * @param locale
	 *            Locale
	 * @param request
	 *            HttpServletRequest
	 * @param model
	 *            Model
	 * @param json
	 *            查詢條件
	 * @return 附件資料
	 */
	@RequestMapping(value = "/s45/attach/query", method = RequestMethod.POST)
	public String QueryAttach(Locale locale, HttpServletRequest request, Model model, @RequestBody String json) {
		JSONObject listjson = new JSONObject();
		if (menuService.getReadPermission(getBaseMemberId(), targetControllerName, targetActionName)) {
			JSONArray sn_array = new JSONArray();
			
			json = WebCrypto.getSafe(json);
			JSONObject obj = new JSONObject(json);
			long MalwareManagementId = obj.isNull("MalwareManagementId") == true ? 0 : obj.getLong("MalwareManagementId");
			List<ViewMalwareManagementAttachMember> malwareManagementAttachs = malwareManagementAttachService.getAllByMalwareManagementId(MalwareManagementId);
			if (malwareManagementAttachs != null) {
				for (ViewMalwareManagementAttachMember malwareManagementAttach : malwareManagementAttachs) {
					long size = malwareManagementAttach.getFileSize();
					if (size <= 0)
						return "0";
					final String[] units = new String[]{"B", "KB", "MB", "GB", "TB"};
					int digitGroups = (int) (Math.log10(size) / Math.log10(1024));
					String fileSize = new DecimalFormat("#,##0.#").format(size / Math.pow(1024, digitGroups)) + " " + units[digitGroups];
					JSONObject sn_json = new JSONObject();
					sn_json.put("MalwareManagementId", malwareManagementAttach.getMalwareManagementId());
					sn_json.put("Id", malwareManagementAttach.getId());
					sn_json.put("FileName", malwareManagementAttach.getFileName());
					sn_json.put("FileType", malwareManagementAttach.getFileType());
					sn_json.put("FileSize", fileSize);
					sn_json.put("FileHash", malwareManagementAttach.getFileHash());
					sn_json.put("FileDesc", malwareManagementAttach.getFileDesc());
					sn_json.put("CreateId", malwareManagementAttach.getCreateId());
					sn_json.put("CreateName", malwareManagementAttach.getCreateName());
					sn_json.put("CreateTime", WebDatetime.toString(malwareManagementAttach.getCreateTime()));
					sn_json.put("ModifyId", malwareManagementAttach.getModifyId());
					sn_json.put("ModifyName", malwareManagementAttach.getModifyName());
					sn_json.put("ModifyTime", WebDatetime.toString(malwareManagementAttach.getModifyTime()));
					sn_array.put(sn_json);
				}
				listjson.put("datatable", sn_array);
				systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Read, SystemLogVariable.Status.Success, getBaseIpAddress(), getBaseMemberAccount());
			}
		} else {
			systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Read, SystemLogVariable.Status.Deny, getBaseIpAddress(), getBaseMemberAccount());
		}
		model.addAttribute("json", listjson.toString());
		return "msg";
	}

	/**
	 * 上傳附件API
	 * 
	 * @param file
	 *            MultipartFile
	 * @param id
	 *            MalwareManagementId
	 * @param fileDesc
	 *            檔案描述
	 * @param model
	 *            Model
	 * @param locale
	 *            Locale
	 * @param request
	 *            HttpServletRequest
	 * @return 是否成功
	 */
	@RequestMapping(value = "/s45/attach/upload", method = RequestMethod.POST)
	public String UploadAttach(@RequestParam("file") MultipartFile file, @RequestParam("id") Long id, @RequestParam("FileDesc") String fileDesc, Model model, Locale locale, HttpServletRequest request) {
		JSONObject responseJson = new JSONObject();
		CsrfToken token = new HttpSessionCsrfTokenRepository().loadToken(request);
		if (token == null || token.getToken().equals(""))
			return responseJson.toString();
		
		if (menuService.getCreatePermission(getBaseMemberId(), targetControllerName, targetActionName)) {
			JSONObject sn_json = new JSONObject();
			sn_json.put("MalwareManagementId", id);
			sn_json.put("FileDesc", fileDesc);
			String json = sn_json.toString();

			if (!file.isEmpty()) {
				try {
					byte[] bytes = file.getBytes();

					sn_json.put("FileName", file.getOriginalFilename());
					sn_json.put("FileType", file.getContentType());
					sn_json.put("FileSize", file.getSize());
					sn_json.put("FileHash", WebCrypto.getHash(WebCrypto.HashType.SHA256, bytes.toString()));
					json = sn_json.toString();
					MalwareManagement malwareManagement = malwareManagementService.get(id);
					if (malwareManagement != null) {
						MalwareManagementAttach entity = malwareManagementAttachService.insert(getBaseMemberId(), json, bytes);
						if (entity != null) {
							responseJson.put("msg", WebMessage.getMessage("globalUploadFileSuccess", null, locale));
							responseJson.put("success", true);
							systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Create, SystemLogVariable.Status.Success, getBaseIpAddress(), getBaseMemberAccount());
						} else {
							responseJson.put("msg", WebMessage.getMessage("globalUploadFileFail", null, locale));
							responseJson.put("success", false);
							systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Create, SystemLogVariable.Status.Fail, getBaseIpAddress(), getBaseMemberAccount());
						}
					} else {
						responseJson.put("msg", WebMessage.getMessage("globalUploadFileFail", null, locale));
						responseJson.put("success", false);
						systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Create, SystemLogVariable.Status.Fail, getBaseIpAddress(), getBaseMemberAccount());
					}
				} catch (Exception e) {
					//e.printStackTrace();
					responseJson.put("msg", WebMessage.getMessage("globalUploadFileFail", null, locale));
					responseJson.put("success", false);
					systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Create, SystemLogVariable.Status.Fail, getBaseIpAddress(), getBaseMemberAccount());
				}
			} else {
				responseJson.put("msg", WebMessage.getMessage("globalUploadFileFail", null, locale));
				responseJson.put("success", false);
				systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Create, SystemLogVariable.Status.Fail, getBaseIpAddress(), getBaseMemberAccount());
			}
		} else {
			systemLogService.insert(baseControllerName, baseActionName, "MalwareManagementId=" + id.toString(), SystemLogVariable.Action.Read, SystemLogVariable.Status.Deny, getBaseIpAddress(), getBaseMemberAccount());
		}
		model.addAttribute("json", responseJson.toString());
		return "msg";
	}

	/**
	 * 刪除附件API
	 * 
	 * @param locale
	 *            Locale
	 * @param request
	 *            HttpServletRequest
	 * @param model
	 *            Model
	 * @param json
	 *            編號
	 * @return 是否刪除成功
	 */
	@RequestMapping(value = "/s45/attach/delete", method = RequestMethod.POST)
	public @ResponseBody String DeleteAttach(Locale locale, HttpServletRequest request, Model model, @RequestBody String json) {
		JSONObject responseJson = new JSONObject();
		CsrfToken token = new HttpSessionCsrfTokenRepository().loadToken(request);
		if (token == null || token.getToken().equals(""))
			return responseJson.toString();
		
		if (menuService.getDeletePermission(getBaseMemberId(), targetControllerName, targetActionName)) {
			json = WebCrypto.getSafe(json);
			JSONObject obj = new JSONObject(json);
			long id = obj.isNull("Id") == true ? 0 : obj.getLong("Id");
			if (!malwareManagementAttachService.isExist(id)) {
				responseJson.put("msg", WebMessage.getMessage("globalDataNotExist", null, locale));
				responseJson.put("success", false);
				systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Delete, SystemLogVariable.Status.Fail, getBaseIpAddress(), getBaseMemberAccount());
			} else {
				if (malwareManagementAttachService.delete(id)) {
					responseJson.put("msg", WebMessage.getMessage("globalDeleteDataSuccess", null, locale));
					responseJson.put("success", true);
					systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Delete, SystemLogVariable.Status.Success, getBaseIpAddress(), getBaseMemberAccount());
				} else {
					responseJson.put("msg", WebMessage.getMessage("globalDeleteDataFail", null, locale));
					responseJson.put("success", false);
					systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Delete, SystemLogVariable.Status.Fail, getBaseIpAddress(), getBaseMemberAccount());
				}
			}
		} else {
			responseJson.put("msg", WebMessage.getMessage("globalPermissionDeny", null, locale));
			responseJson.put("success", false);
			systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Delete, SystemLogVariable.Status.Deny, getBaseIpAddress(), getBaseMemberAccount());
		}
		return WebCrypto.getSafe(responseJson.toString());

	}

	/**
	 * 附件下載
	 * 
	 * @param locale
	 *            Locale
	 * @param request
	 *            HttpServletRequest
	 * @param response
	 *            HttpServletResponse
	 * @param MalwareManagementId
	 *            文章Id
	 * @param id
	 *            附件Id
	 */
	@SuppressWarnings("deprecation")
	@RequestMapping(value = "/s45/attach/download/{malwareManagementId}/{id}", method = RequestMethod.GET)
	public void DownloadAttach(Locale locale, HttpServletRequest request, HttpServletResponse response, @PathVariable Long malwareManagementId, @PathVariable Long id) {
		JSONObject sn_json = new JSONObject();
		sn_json.put("MalwareManagementId", malwareManagementId);
		sn_json.put("Id", id);
		String json = sn_json.toString();
		if (menuService.getReadPermission(getBaseMemberId(), targetControllerName, targetActionName)) {
			if (!malwareManagementService.isExist(malwareManagementId)) {
				systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Read, SystemLogVariable.Status.Fail, getBaseIpAddress(), getBaseMemberAccount());
				try {
					response.sendError(HttpServletResponse.SC_NOT_FOUND);
				} catch (IOException ex) {
					//ex.printStackTrace();
				}
			} else if (!malwareManagementAttachService.isExist(id)) {
				systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Read, SystemLogVariable.Status.Fail, getBaseIpAddress(), getBaseMemberAccount());
				try {
					response.sendError(HttpServletResponse.SC_NOT_FOUND);
				} catch (IOException ex) {
					//ex.printStackTrace();
				}
			} else {
				response.reset();
				MalwareManagementAttach malwareManagementAttach = malwareManagementAttachService.getById(id);
				try {
					byte[] buffer = malwareManagementAttach.getFileContent();
					// 下面這行被註解是因為，點擊下載連結後，會發生找不到檔案的問題，暫時改用第２行的語法
					// response.addHeader("Content-Disposition",
					// "attachment;filename=" +
					// URLEncoder.encode(MalwareManagementAttach.getFileName(),
					// StandardCharsets.UTF_8.toString()));
					response.addHeader("Content-Disposition", "attachment;filename=" + URLEncoder.encode(malwareManagementAttach.getFileName()));
					response.addHeader("Content-Length", "" + buffer.length);
					OutputStream toClient = new BufferedOutputStream(response.getOutputStream());
					response.setContentType("application/octet-stream");
					toClient.write(buffer);
					toClient.flush();
					toClient.close();
					systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Read, SystemLogVariable.Status.Success, getBaseIpAddress(), getBaseMemberAccount());
				} catch (IOException ex) {
					//ex.printStackTrace();
					systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Read, SystemLogVariable.Status.Fail, getBaseIpAddress(), getBaseMemberAccount());
				}
			}
		} else {
			systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Read, SystemLogVariable.Status.Deny, getBaseIpAddress(), getBaseMemberAccount());
		}
	}

	/**
	 * 審核勒索專區資料API
	 * 
	 * @param locale
	 *            Locale
	 * @param request
	 *            HttpServletRequest
	 * @param json
	 *            編號
	 * @return 審核動作是否成功
	 */
	@RequestMapping(value = "/s45/examine", method = RequestMethod.POST)
	public @ResponseBody String Examine(Locale locale, HttpServletRequest request, @RequestBody String json) {

		JSONObject responseJson = new JSONObject();
		CsrfToken token = new HttpSessionCsrfTokenRepository().loadToken(request);
		if (token == null || token.getToken().equals(""))
			return responseJson.toString();

		if (menuService.getUpdatePermission(getBaseMemberId(), targetControllerName, targetActionName)) {
			json = WebCrypto.getSafe(json);
			JSONObject obj = new JSONObject(json);
			Long id = obj.isNull("Id") == true ? 0 : obj.getLong("Id");
			Long status = obj.isNull("Status") == true ? 0 : obj.getLong("Status");

			// 簽核用
			// String preStatus = obj.isNull("PreStatus") == true ? null :
			// obj.getString("PreStatus");
			// String opinion = obj.isNull("Opinion") == true ? null :
			// obj.getString("Opinion");

			if (!malwareManagementService.isExist(id)) {
				responseJson.put("msg", WebMessage.getMessage("globalDataNotExist", null, locale));
				responseJson.put("success", false);

				systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Update, SystemLogVariable.Status.Fail, getBaseIpAddress(), getBaseMemberAccount());
			} else {

				// String oldPostId =
				// MalwareManagementService.getById(String.valueOf(id)).getPostId();

				ProcessLog processLog = processLogService.insert(getBaseMemberId(), json, String.valueOf(id));
				MalwareManagement MalwareManagement = malwareManagementService.examine(getBaseMemberId(), String.valueOf(id), String.valueOf(status));

				if (MalwareManagement != null && processLog != null) {
					responseJson.put("msg", WebMessage.getMessage("globalUpdateDataSuccess", null, locale));
					responseJson.put("success", true);

					systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Update, SystemLogVariable.Status.Success, getBaseIpAddress(), getBaseMemberAccount());

					// 清除快取
					malwareManagementService.resetGlobalData();
				} else {
					responseJson.put("msg", WebMessage.getMessage("globalUpdateDataFail", null, locale));
					responseJson.put("success", false);

					systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Update, SystemLogVariable.Status.Fail, getBaseIpAddress(), getBaseMemberAccount());
				}
			}
			// } else {
			// json.put("msg", "PermissionDenied");
			// json.put("success", false);
			// }
		} else {
			systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Update, SystemLogVariable.Status.Deny, getBaseIpAddress(), getBaseMemberAccount());
		}
		return WebCrypto.getSafe(responseJson.toString());
	}

	/**
	 * 取得勒索專區button count資料API
	 * 
	 * @param locale
	 *            Locale
	 * @param request
	 *            HttpServletRequest
	 * @param model
	 *            Model
	 * @param json
	 *            查詢條件`
	 * @return 勒索專區button count資料
	 */
	@RequestMapping(value = "/s45/query/button/count", method = RequestMethod.POST)
	public String QueryButtonCount(Locale locale, HttpServletRequest request, Model model, @RequestBody String json) {
		JSONObject listjson = new JSONObject();
		if (menuService.getReadPermission(getBaseMemberId(), targetControllerName, targetActionName)) {
			json = WebCrypto.getSafe(json);
			JSONObject obj = new JSONObject(json);
			/*
			 * 1-SuperAdmin 2-H-ISAC管理者 3-H-ISAC內容維護者 4-H-ISAC內容審核者
			 * 5-H-ISAC警訊建立者 6-H-ISAC警訊審核者 12-HISAC通報審核者 13-HISAC情資維護者
			 * 14-HISAC-情資審核者 8-權責單位聯絡人 9-權責單位管理者 7-權責單位警訊審核者 15-權責單位通報審核者
			 * 10-會員機構聯絡人 11-會員機構管理者
			 */
			if (baseMemberRole.IsAdmin == true) {
				obj.put("RoleId", 1);
			} else if (baseMemberRole.IsHisac == true) {
				obj.put("RoleId", 2);
			} else if (baseMemberRole.IsHisacContent == true) {
				obj.put("RoleId", 3);
			} else if (baseMemberRole.IsHisacContentSign == true) {
				obj.put("RoleId", 4);
			}

			obj.put("MemberId", getBaseMemberId());
			json = obj.toString();

			JSONArray sn_array = new JSONArray();
			List<SpButtonCount> spButtonCounts = malwareManagementService.getSpButtonCount(json);
			if (spButtonCounts != null)
				for (SpButtonCount spButtonCount : spButtonCounts) {
					JSONObject sn_json = new JSONObject();
					sn_json.put("Status", spButtonCount.getStatus());
					sn_json.put("Count", spButtonCount.getCount());
					sn_array.put(sn_json);
				}

			listjson.put("datatable", sn_array);

			systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Read, SystemLogVariable.Status.Success, getBaseIpAddress(), getBaseMemberAccount());
		} else {
			systemLogService.insert(baseControllerName, baseActionName, json, SystemLogVariable.Action.Read, SystemLogVariable.Status.Deny, getBaseIpAddress(), getBaseMemberAccount());
		}

		model.addAttribute("json", listjson.toString());
		return "msg";

	}

}